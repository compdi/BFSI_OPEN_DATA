<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BFSI Open Data — Hospital Blacklist Search</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{--bg:#f7f8fb;--card:#fff;--muted:#65737e;--accent:#0b6b63;--badge-green:#dff7ec;--badge-red:#ffecec}
  body{font-family:Inter,system-ui,Arial,sans-serif;margin:0;background:var(--bg);color:#0b1820}
  .wrap{max-width:980px;margin:28px auto;padding:20px}
  header{display:flex;align-items:center;justify-content:space-between}
  h1{margin:0;font-size:22px}
  p.sub{margin:6px 0 20px;color:var(--muted)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
  .search{flex:1;min-width:220px}
  input[type="search"]{width:100%;padding:12px 14px;border:1px solid #e1e6eb;border-radius:8px;font-size:15px}
  button{background:#0b6b63;color:#fff;border:0;padding:10px 14px;border-radius:8px;cursor:pointer}
  .secondary{background:#fff;border:1px solid #d7dde2;color:#0b1820}
  .small{padding:8px 10px;font-size:13px}
  .info{margin:12px 0;color:#1f8a5b}
  .count{margin:10px 0;color:#223}
  .list{display:grid;gap:10px}
  .card{background:var(--card);border-radius:10px;padding:14px;border:1px solid #e6eaee;display:flex;justify-content:space-between;align-items:center}
  .meta{color:var(--muted);font-size:13px;margin-top:6px}
  .badge{padding:6px 10px;border-radius:999px;font-size:13px}
  .badge.black{background:var(--badge-red);color:#b02a2a}
  .badge.active{background:var(--badge-green);color:#166d35}
  .uploader{display:flex;gap:8px;align-items:center}
  .textarea{width:100%;min-height:80px;padding:10px;border-radius:8px;border:1px dashed #cfd8df;background:#fff}
  .footer{margin-top:18px;color:var(--muted);font-size:13px}
  .hidden{display:none}
  @media(max-width:640px){header{flex-direction:column;align-items:flex-start} .controls{flex-direction:column}}
</style>
</head>
<body>
<div class="wrap" id="app">
  <header>
    <div>
      <h1>BFSI Open Data — Hospital Blacklist Search</h1>
      <p class="sub">Quickly search hospitals and check blacklist status</p>
    </div>
    <div style="text-align:right"><img src="" alt="BFSI Logo" style="height:34px;opacity:.7"></div>
  </header>

  <div class="controls">
    <div class="search">
      <input id="q" type="search" placeholder="Search hospital name or city..." aria-label="search">
    </div>

    <!-- Admin tools - hidden by default -->
    <div id="adminTools" class="uploader hidden">
      <button id="btnSample" class="small secondary">Use sample data</button>
      <label class="small secondary" style="display:inline-block;padding:9px 10px;border-radius:8px;cursor:pointer;">
        Upload CSV<input id="file" type="file" accept=".csv,.json" style="display:none">
      </label>
      <button id="btnPaste" class="small secondary">Paste CSV/JSON</button>
      <button id="btnLogout" class="small secondary" title="Exit admin mode">Logout</button>
    </div>
  </div>

  <p id="adminHint" style="font-size:12px;color:#bbb;text-align:right;margin-top:-10px;">
    Press <strong>Ctrl + A</strong> to open admin mode (you only).
  </p>

  <div id="pasteArea" class="hidden" style="margin-bottom:10px">
    <textarea id="paste" class="textarea" placeholder="Paste CSV or JSON here (include header row)"></textarea>
    <div style="margin-top:8px">
      <button id="btnLoad" class="small">Load pasted data</button>
      <button id="btnCancelPaste" class="small secondary">Cancel</button>
    </div>
  </div>

  <div id="status" class="info" aria-live="polite"></div>
  <div id="count" class="count"></div>

  <div id="list" class="list" aria-live="polite"></div>

  <div class="footer">Tip: paste a few rows from Excel as CSV or upload your CSV. If dataset is large (&gt;1000 rows) browser may slow; use sample for demo. Admin controls are hidden from public users.</div>
</div>

<script>
(function(){
  // ----- CONFIG -----
  const ADMIN_PASSWORD = "km@2025"; // change if you like
  const MAX_RENDER = 500;
  const PREVIEW_LIMIT = 200;
  const DEBOUNCE_MS = 250;

  // ----- SAMPLE DATA -----
  let hospitals = [
    {"hospital_name":"Care Life Hospital","city":"Thane","state":"Maharashtra","status":"Blacklisted","insurer":"Aditya Birla Health"},
    {"hospital_name":"City General Hospital","city":"Mumbai","state":"Maharashtra","status":"Active","insurer":"ICICI Lombard"},
    {"hospital_name":"Sunrise Multi Speciality","city":"Pune","state":"Maharashtra","status":"Blacklisted","insurer":"HDFC ERGO"},
    {"hospital_name":"Green Valley Clinic","city":"Bengaluru","state":"Karnataka","status":"Active","insurer":"Bajaj Allianz"},
    {"hospital_name":"Sankalp Eye Hospital","city":"Hyderabad","state":"Telangana","status":"De-empanelled","insurer":""},
    {"hospital_name":"Seva Critical Care","city":"Delhi","state":"Delhi","status":"Blacklisted","insurer":"Star Health"}
  ];
  const hospitalsSampleBackup = [...hospitals];

  // ----- ELEMENTS -----
  const el = {
    q: document.getElementById('q'),
    list: document.getElementById('list'),
    count: document.getElementById('count'),
    status: document.getElementById('status'),
    file: document.getElementById('file'),
    btnSample: document.getElementById('btnSample'),
    btnPaste: document.getElementById('btnPaste'),
    pasteArea: document.getElementById('pasteArea'),
    paste: document.getElementById('paste'),
    btnLoad: document.getElementById('btnLoad'),
    btnCancelPaste: document.getElementById('btnCancelPaste'),
    adminTools: document.getElementById('adminTools'),
    adminHint: document.getElementById('adminHint'),
    btnLogout: document.getElementById('btnLogout')
  };

  // ----- CSV parser (robust simple parser handles quoted fields) -----
  function CSVToArray(strData, strDelimiter) {
    strDelimiter = (strDelimiter || ",");
    var objPattern = new RegExp(
      (
        "(\\\""+strDelimiter+"|\\r?\\n|\\r|^)" +
        "(?:\"([^\"]*(?:\"\"[^\"]*)*)\"|" +
        "([^\"\\" + strDelimiter + "\\r\\n]*))"
      ),
      "gi"
    );
    var arrData = [[]];
    var arrMatches = null;
    while ((arrMatches = objPattern.exec(strData))) {
      var strMatchedDelimiter = arrMatches[1];
      if (strMatchedDelimiter.length && (strMatchedDelimiter !== strDelimiter)) {
        arrData.push([]);
      }
      var strMatchedValue;
      if (arrMatches[2]) {
        strMatchedValue = arrMatches[2].replace(/\"\"/g, "\"");
      } else {
        strMatchedValue = arrMatches[3];
      }
      arrData[arrData.length - 1].push(strMatchedValue);
    }
    return arrData;
  }

  function parseCSV(text) {
    const arr = CSVToArray(text.trim(), ",");
    if(arr.length < 1) return [];
    const headers = arr[0].map(h => (h||'').toString().trim());
    const rows = arr.slice(1).map(row=>{
      const obj = {};
      for(let i=0;i<headers.length;i++){
        obj[headers[i]] = row[i] === undefined ? '' : row[i];
      }
      return obj;
    }).filter(r => Object.values(r).some(x => x !== null && x !== ''));
    return rows;
  }

  // ----- Helpers -----
  function normalizeStr(s){ return (s||'').toString().trim().toLowerCase(); }
  function showStatus(txt, holdMs=5000){ el.status.textContent = txt; if(holdMs>0) setTimeout(()=>{ if(el.status.textContent===txt) el.status.textContent = '' }, holdMs); }

  function renderList(items){
    el.list.innerHTML = '';
    el.count.textContent = items.length + (items.length===1 ? ' hospital found' : ' hospitals found');
    if(!items.length){ el.list.innerHTML = '<div style="color:#666">No results</div>'; return; }
    const r = items.slice(0, MAX_RENDER);
    r.forEach(it=>{
      const card = document.createElement('div'); card.className='card';
      const left = document.createElement('div');
      const name = document.createElement('div'); name.innerHTML = '<strong>'+ (it.hospital_name||'—') +'</strong>';
      const cityState = document.createElement('div'); cityState.className='meta';
      cityState.textContent = (it.city? (it.city + (it.state? ', '+it.state : '')) : (it.state||''));
      const insurer = document.createElement('div'); insurer.className='meta'; insurer.style.marginTop='6px'; insurer.textContent = 'Insurer: ' + (it.insurer || '—');
      left.appendChild(name); left.appendChild(cityState); left.appendChild(insurer);

      const right = document.createElement('div'); right.style.textAlign='right';
      const st = (it.status||'Unknown').toLowerCase();
      const badge = document.createElement('div');
      badge.className='badge '+(st.includes('active')?'active':(st.includes('black')?'black':'')); 
      badge.textContent = it.status || 'Unknown';
      right.appendChild(badge);

      card.appendChild(left); card.appendChild(right);
      el.list.appendChild(card);
    });
    if(items.length > MAX_RENDER){
      const more = document.createElement('div'); more.style.color='#666'; more.style.marginTop='6px';
      more.textContent = `Showing ${MAX_RENDER} of ${items.length} results. Refine search to see fewer results.`;
      el.list.appendChild(more);
    }
  }

  // ----- SEARCH (debounced) -----
  let timer = null;
  function doSearch(){
    const q = normalizeStr(el.q.value);
    if(!q){ renderList(hospitals.slice(0, PREVIEW_LIMIT)); return; }
    const out = hospitals.filter(r=>{
      return normalizeStr(r.hospital_name).includes(q) || normalizeStr(r.city).includes(q);
    });
    renderList(out);
  }
  el.q.addEventListener('input', ()=> {
    clearTimeout(timer);
    timer = setTimeout(doSearch, DEBOUNCE_MS);
  });

  // ----- FILE UPLOAD (client-only) -----
  el.file.addEventListener('change', function(e){
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      const text = evt.target.result;
      parseAndLoad(text);
    };
    reader.readAsText(f, 'utf-8'); // try utf-8
  });

  // ----- PASTE UI -----
  el.btnPaste.addEventListener('click', ()=> { el.pasteArea.classList.remove('hidden'); el.paste.focus(); });
  el.btnCancelPaste.addEventListener('click', ()=> { el.pasteArea.classList.add('hidden'); el.paste.value=''; });
  el.btnLoad.addEventListener('click', ()=> {
    const txt = el.paste.value.trim(); if(!txt){ alert('Paste CSV or JSON first'); return; }
    parseAndLoad(txt);
    el.pasteArea.classList.add('hidden'); el.paste.value='';
  });

  // ----- SAMPLE BUTTON -----
  el.btnSample.addEventListener('click', ()=> { hospitals = [...hospitalsSampleBackup]; showStatus('Sample data loaded'); renderList(hospitals.slice(0, PREVIEW_LIMIT)); });

  // ----- PARSE & MAP -----
  function parseAndLoad(text){
    showStatus('Parsing data...', 20000);
    text = text.trim();
    // try JSON first
    try {
      const maybe = JSON.parse(text);
      if(Array.isArray(maybe)){
        hospitals = mapRecords(maybe);
        afterLoad();
        return;
      }
    } catch(e){}
    // else try CSV
    const parsedRows = parseCSV(text);
    if(parsedRows && parsedRows.length){
      hospitals = mapRecords(parsedRows);
      afterLoad();
      return;
    }
    showStatus('Could not parse data. Ensure CSV has headers or paste valid JSON array.', 8000);
  }

  function mapRecords(rows){
    const keysFromRow = r => Object.keys(r||{});
    return rows.map(r=>{
      const obj = {};
      const keys = keysFromRow(r);
      const get = (variants)=>{
        for(const v of variants){
          if(r[v] !== undefined && r[v] !== null && String(r[v]).trim() !== '') return String(r[v]).trim();
        }
        // case-insensitive fallback
        const lowerMap = {};
        for(const k of keys) lowerMap[k.toLowerCase()] = r[k];
        for(const v of variants){
          if(lowerMap[v.toLowerCase()] !== undefined && lowerMap[v.toLowerCase()] !== null && String(lowerMap[v.toLowerCase()]).trim() !== '') return String(lowerMap[v.toLowerCase()]).trim();
        }
        return '';
      };
      obj.hospital_name = get(['hospital_name','hospital','name','hospitalname']) || '';
      obj.address = get(['address','addr','address_line']);
      obj.city = get(['city','town','district']);
      obj.state = get(['state','st','province']);
      obj.status = get(['status','blacklist_status','delisted_status']) || 'Unknown';
      obj.insurer = get(['insurer','company','payer']);
      obj.action_date = get(['action_date','date','delisted_on']);
      obj.geo_lat = get(['geo_lat','latitude','lat']);
      obj.geo_lng = get(['geo_lng','longitude','long','lng']);
      return obj;
    }).filter(x=>x.hospital_name && x.hospital_name.length>0);
  }

  function afterLoad(){
    showStatus('Custom data loaded ('+hospitals.length+' rows)', 6000);
    if(hospitals.length > 1000) showStatus('Warning: large dataset loaded ('+hospitals.length+'). Browser may slow.', 9000);
    renderList(hospitals.slice(0, PREVIEW_LIMIT));
  }

  // ----- ADMIN MODE -----
  let adminMode = false;
  document.addEventListener("keydown", function (e) {
    if (e.ctrlKey && e.key.toLowerCase() === "a") {
      const pwd = prompt("Enter Admin Password:");
      if (pwd === ADMIN_PASSWORD) {
        adminMode = true;
        el.adminTools.classList.remove('hidden');
        showStatus('Admin mode enabled', 4000);
      } else {
        alert("Incorrect password");
      }
    }
  });
  el.btnLogout.addEventListener('click', function(){
    adminMode = false;
    el.adminTools.classList.add('hidden');
    showStatus('Admin mode disabled', 3000);
  });

  // ----- initial render -----
  renderList(hospitals.slice(0, PREVIEW_LIMIT));

})();
</script>
</body>
</html>
